cmake_minimum_required(VERSION 3.24)

project(OpenCVBuilder)

SET(OPENCV_VERSION 4.8.0)

include(ExternalProject)

SET(OPENCV_BUILD_ROOT ${CMAKE_BINARY_DIR})
SET(OPENCV_INSTALL_ROOT ${CMAKE_BINARY_DIR}/install)

FILE(MAKE_DIRECTORY ${OPENCV_BUILD_ROOT})

SET(CMAKE_GENERATOR Ninja CACHE INTERNAL "")
SET(CMAKE_BUILD_TYPE Debug CACHE INTERNAL "")
SET(CMAKE_CXX_COMPILER /usr/bin/clang++ CACHE INTERNAL "")
SET(CMAKE_CXX_FLAGS "-Wall" CACHE INTERNAL "")
SET(CMAKE_CXX_FLAGS_DEBUG "-g" CACHE I NTERNAL "")
SET(CMAKE_CXX_FLAGS_MINSIZEREL "-Os -DNDEBUG" CACHE INTERNAL "")
SET(CMAKE_CXX_FLAGS_RELEASE "-O4 -DNDEBUG" CACHE INTERNAL "")
SET(CMAKE_CXX_FLAGS_RELWITHDEBINFO "-O2 -g" CACHE INTERNAL "")
SET(CMAKE_LINKER "/usr/bin/llvm-ld" CACHE INTERNAL "")
SET(CMAKE_CXX_FLAGS "-std=c++17" CACHE INTERNAL "")
SET(BUILD_SHARED_LIBS OFF CACHE INTERNAL "")
# SET(BUILD_opencv_python3 OFF CACHE INTERNAL "")
# SET(BUILD_opencv_python_bindings_generator ON CACHE INTERNAL "")
# SET(BUILD_opencv_python2 OFF CACHE INTERNAL "")
# SET(BUILD_JAVA OFF CACHE INTERNAL "")   
# SET(BUILD_FAT_JAVA_LIB OFF CACHE INTERNAL "")

SET(CMAKE_INSTALL_PREFIX ${OPENCV_INSTALL_ROOT} CACHE PATH "install folder" FORCE)

ExternalProject_Add(OpenCV
    GIT_REPOSITORY https://github.com/opencv/opencv.git
    GIT_TAG ${OPENCV_VERSION}
    # UPDATE_DISCONNECTED TRUE
    PREFIX ${CMAKE_BINARY_DIR}
    CMAKE_ARGS
        -DCMAKE_BUILD_TYPE=Debug
        -DCMAKE_INSTALL_PREFIX=${OPENCV_INSTALL_ROOT}
        -DBUILD_SHARED_LIBS=OFF
        -DBUILD_opencv_python3=OFF
        -DBUILD_opencv_python_bindings_generator=OFF
        -DBUILD_JAVA=OFF
        -DBUILD_FAT_JAVA_LIB=OFF
        -DBUILD_opencv_java_bindings_generator=OFF
        -DBUILD_opencv_js=OFF
        -DBUILD_opencv_python2=OFF
        -DENABLE_PYLINT=OFF
        -DENABLE_FLAKE8=OFF
    # SOURCE_DIR ${CMAKE_BINARY_DIR}/src
    # BINARY_DIR ${CMAKE_BINARY_DIR}/build
    # INSTALL_DIR ${OPENCV_INSTALL_ROOT}
    # CONFIGURE_COMMAND ${CMAKE_COMMAND} -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/install -DBUILD_SHARED_LIBS=OFF -DBUILD_opencv_python3=OFF -DBUILD_opencv_python_bindings_generator=ON -DBUILD_JAVA=OFF -DBUILD_FAT_JAVA_LIB=OFF -DBUILD_opencv_java_bindings_generator=OFF -DBUILD_opencv_js=OFF -DBUILD_opencv_python2=OFF -DENABLE_PYLINT=OFF -DENABLE_FLAKE8=OFF ${CMAKE_CURRENT_SOURCE_DIR}
    # BUILD_COMMAND ${CMAKE_COMMAND} --build ${OPENCV_BUILD_ROOT}
    INSTALL_COMMAND ${CMAKE_COMMAND} --install ${OPENCV_BUILD_ROOT}/src/OpenCV-build/ --prefix ${OPENCV_INSTALL_ROOT}
    # INSTALL_COMMAND make DESTDIR=${OPENCV_INSTALL_ROOT} install
)
